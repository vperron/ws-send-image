<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <h1>WebSocket Client</h1>

    <canvas id="image"></canvas>

  </body>
  <script>
document.addEventListener("DOMContentLoaded", function() { 
  try{
    var w = null;
    var h = null;

    function handleData(msg) {
      if ((!w) || (!h)) {
        console.error('error: did not have the image size !');
        return;
      }

      // Init canvas handles
      var element = document.getElementById('image');
      var ctx = element.getContext('2d');
      ctx.canvas.width = w;
      ctx.canvas.height = h;
      var imgData = ctx.createImageData(w, h);

      // Copy data
      var binary = new Uint8Array(msg.data);
      for(var i=8; i < binary.length; i++) {
        imgData.data[i] = binary[i];
      }

      // Draw to canvas
      ctx.putImageData(imgData, 0, 0);
    }

    function handleInfo(msg) {
      var imgInfo = JSON.parse(msg.data);
      w = imgInfo.width;
      h = imgInfo.height;
    }

    // Create websocket
    var socket = new WebSocket("ws://127.0.0.1:8080");
    socket.binaryType = "arraybuffer";
    console.log('init:', socket.readyState);

    socket.onopen = function(){
      console.log('onopen:', socket.readyState);
    }

    socket.onmessage = function(msg){
      if (msg.data instanceof ArrayBuffer) {
        handleData(msg);
        console.log('onmessage: image data received');
      } else {
        handleInfo(msg);
        console.log('onmessage: image info received', msg);
      }
    }

    socket.onclose = function(){
      console.log('onclose:', socket.readyState);
    }

  } catch(exception){
    console.error('Error', exception);
  }
});
  </script>
</html>
